// Cấu hình API chuẩn
const API_LIST = "https://phimapi.com/v1/api/danh-sach/phim-moi-cap-nhat?limit=18";
const IMG_URL = "https://phimimg.com/";
let listPhim = [];

// Hàm khởi tạo chính
async function loadHome() {
    const heroTitle = document.getElementById('hero-title');
    const grid = document.getElementById('movie-grid');

    try {
        // Thử fetch dữ liệu
        const res = await fetch(API_LIST);
        if (!res.ok) throw new Error("Network response was not ok");
        
        const data = await res.json();
        listPhim = data.data.items;

        if (listPhim && listPhim.length > 0) {
            renderBanner(listPhim[0]);
            renderGrid(listPhim);
        } else {
            throw new Error("Dữ liệu trống");
        }

    } catch (err) {
        console.error("Lỗi kết nối:", err);
        // Nếu lỗi, hiển thị thông báo thân thiện hơn thay vì để trống
        heroTitle.innerText = "ĐANG CẬP NHẬT HỆ THỐNG";
        grid.innerHTML = `<div class="col-span-full text-center py-10 text-gray-500 italic">
            Hệ thống đang bảo trì kết nối API, vui lòng quay lại sau vài phút...
        </div>`;
    }
}

// Hàm render Banner để tránh lỗi "Đang tải..."
function renderBanner(first) {
    const bg = document.getElementById('banner-bg');
    const title = document.getElementById('hero-title');
    const sub = document.getElementById('hero-sub');
    const btn = document.getElementById('hero-play-btn');

    bg.style.backgroundImage = `url('${IMG_URL}${first.poster_url}')`;
    title.innerText = first.name;
    sub.innerText = first.origin_name;
    btn.onclick = () => openOverlay(first.slug);
}

// Hàm render Lưới phim
function renderGrid(phims) {
    const grid = document.getElementById('movie-grid');
    grid.innerHTML = phims.map(p => `
        <div class="movie-card group cursor-pointer" onclick="openOverlay('${p.slug}')">
            <div class="relative aspect-[2/3] overflow-hidden rounded-xl bg-[#25252b]">
                <img src="${IMG_URL}${p.thumb_url}" class="w-full h-full object-cover group-hover:scale-110 transition duration-500" 
                     onerror="this.src='https://via.placeholder.com/300x450?text=No+Image'">
                <div class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition flex items-center justify-center">
                    <div class="w-12 h-12 bg-yellow-500 rounded-full flex items-center justify-center text-black shadow-lg">
                        <i class="fas fa-play text-sm"></i>
                    </div>
                </div>
            </div>
            <h3 class="text-[13px] font-bold mt-3 truncate uppercase group-hover:text-yellow-500 transition">${p.name}</h3>
            <p class="text-[10px] text-gray-500 truncate italic">${p.origin_name}</p>
        </div>
    `).join('');
}

// Mở Overlay (Giữ nguyên logic cũ nhưng thêm bọc Try-Catch)
async function openOverlay(slug) {
    try {
        const res = await fetch(`https://phimapi.com/phim/${slug}`);
        const data = await res.json();
        const m = data.movie;
        const eps = data.episodes[0].server_data;

        document.getElementById('ov-header-title').innerText = `XEM PHIM: ${m.name}`;
        document.getElementById('ov-title').innerText = m.name;
        document.getElementById('ov-sub').innerText = m.origin_name;
        document.getElementById('ov-desc').innerHTML = m.content;
        document.getElementById('ov-poster').src = m.thumb_url;
        document.getElementById('ov-year').innerText = m.year;
        document.getElementById('ov-status').innerText = m.episode_current;
        document.getElementById('ov-rating').innerText = `IMDb ${m.tmdb.vote_average || 'N/A'}`;

        const epBox = document.getElementById('ov-episodes');
        epBox.innerHTML = eps.map((e, i) => `
            <button onclick="playVideo('${e.link}', this)" 
                    class="ep-btn bg-[#25252b] py-2.5 rounded font-black text-[11px] hover:bg-yellow-500 hover:text-black transition border border-white/5 ${i===0?'bg-yellow-500 text-black':''}">
                ${e.name}
            </button>
        `).join('');

        playVideo(eps[0].link);
        document.getElementById('movie-overlay').classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    } catch (e) {
        alert("Server phim đang bận, thử lại sau!");
    }
}

function playVideo(url, btn) {
    document.getElementById('main-player').src = url;
    if(btn) {
        document.querySelectorAll('.ep-btn').forEach(b => {
            b.classList.remove('bg-yellow-500', 'text-black');
            b.classList.add('bg-[#25252b]');
        });
        btn.classList.add('bg-yellow-500', 'text-black');
    }
}

function closeOverlay() {
    document.getElementById('movie-overlay').classList.add('hidden');
    document.getElementById('main-player').src = "";
    document.body.style.overflow = 'auto';
}

// Tự động chạy khi load trang
window.addEventListener('DOMContentLoaded', loadHome);
